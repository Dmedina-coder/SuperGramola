<link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
<div class="container">
	<div class="cuadro">
		<div class="header-container">
			<a class="back-arrow" routerLink="/" *ngIf="!isLocked">
				<span class="material-icons" style="color: black; font-size: 1.2rem;">arrow_back</span>		
			</a>
			<h2>SuperGramola</h2>
			<button class="lock-button" (click)="toggleLock()" [title]="isLocked ? 'Desbloquear' : 'Bloquear'">
				<span class="material-icons">{{ isLocked ? 'lock' : 'lock_open' }}</span>
			</button>
		</div>
		
		<!-- Paso 1: Selecci√≥n de Playlist -->
		<div class="playlist-section" *ngIf="currentStep === 1">
			<h3>Paso 1: Selecciona una Playlist</h3>
			<div class="playlists-scrollable" *ngIf="playlists.length > 0">
				<button 
					*ngFor="let pl of playlists" 
					class="playlist-button"
					(click)="selectPlaylist(pl)">
					<div class="playlist-info">
						<span class="playlist-name">{{ pl.name }}</span>
						<span class="playlist-tracks">{{ pl.tracks.total }} canciones</span>
					</div>
				</button>
			</div>
			<p *ngIf="playlists.length === 0" class="loading-message">Cargando playlists...</p>
		</div>

		<!-- Paso 2: Selecci√≥n de Dispositivo -->
		<div class="device-section" *ngIf="currentStep === 2">
			<h3>Paso 2: Selecciona un Dispositivo</h3>
			<p class="info-text">Playlist seleccionada: <strong>{{ selectedPlaylist.name }}</strong></p>
			<div class="devices-scrollable" *ngIf="devices.length > 0">
				<button 
					*ngFor="let device of devices" 
					class="device-button"
					(click)="selectDevice(device)">
					<div class="device-info">
						<span class="device-name">{{ device.name }}</span>
						<span class="device-type">{{ device.type }} - {{ device.is_active ? 'üü¢ Activo' : '‚ö™ Inactivo' }}</span>
					</div>
				</button>
			</div>
			<p *ngIf="devices.length === 0" class="loading-message">Cargando dispositivos disponibles...</p>
			<button class="back-button" (click)="currentStep = 1" *ngIf="!isLocked">‚Üê Volver a Playlists</button>
		</div>

		<!-- Paso 3: Canciones y Reproducci√≥n -->
		<div class="tracks-section" *ngIf="currentStep === 3">
			<div class="header-with-lock">
				<div>
					<h3>üéµ Reproduciendo: {{ selectedPlaylist.name }}</h3>
					<p class="info-text">Dispositivo: <strong>{{ selectedDevice.name }}</strong></p>
				</div>
				
			</div>
			<div class="tracks-scrollable">
				<div 
					*ngFor="let item of playlistTracks; let i = index" 
					class="track-item"
					[class.playing]="isTrackPlaying(item.track)">
					<span class="track-number">{{ i + 1 }}</span>
					<div class="track-info">
						<span class="track-name">{{ item.track.name }}</span>
						<span class="track-artist">{{ item.track.artists[0].name }}</span>
					</div>
					<span class="track-duration">{{ formatDuration(item.track.duration_ms) }}</span>
				</div>
			</div>
			<button class="back-button" (click)="currentStep = 2; loadDevices()" *ngIf="!isLocked">‚Üê Cambiar Dispositivo</button>
		</div>
	
		<!-- Modal de b√∫squeda (visible en cualquier paso) -->
		<button class="search-button" (click)="openModal()" *ngIf="currentStep === 3">
			üîç Buscar canci√≥n
		</button>
	
		<div class="modal-overlay" *ngIf="showModal">
			<div class="modal">
				<div class="modal-header">
					<div>
						<h3>üîç Buscar canci√≥n</h3>
						<h4>Coste: {{ costeCancion.toFixed(2) }}‚Ç¨</h4>
					</div>
					<button class="close-button" (click)="closeModal()">‚úñ</button>
				</div>
				<div class="modal-body">
					<input 
						type="text" 
						[(ngModel)]="searchTerm" 
						(ngModelChange)="onSearchChange($event)"
						placeholder="Busca por canci√≥n o artista..."
						autofocus />
					
					<div class="search-status" *ngIf="isSearching">
						<span class="loading-spinner">üîÑ</span> Buscando...
					</div>
		
					<div class="search-results" *ngIf="searchResults.length > 0">
						<div 
							*ngFor="let track of searchResults" 
							class="search-result-item"
							(click)="addToQueue(track)">
							<img 
								[src]="track.album.images[2]?.url || track.album.images[0]?.url" 
								[alt]="track.name"
								class="track-image">
							<div class="track-details">
								<div class="track-title">{{ track.name }}</div>
								<div class="track-artist-album">
									{{ track.artists[0].name }} ‚Ä¢ {{ track.album.name }}
								</div>
							</div>
							<div class="track-add">
								<span class="material-icons">add_circle_outline</span>
							</div>
						</div>
					</div>
					<p *ngIf="searchResults.length === 0 && !isSearching && searchTerm" class="no-results">
						No se encontraron resultados para "{{ searchTerm }}"
					</p>
					<p *ngIf="!searchTerm && !isSearching" class="search-hint">
						üí° Escribe el nombre de una canci√≥n o artista
					</p>
				</div>
			</div>
		</div>

		<!-- Modal de PIN para bloqueo/desbloqueo -->
		<div class="modal-overlay" *ngIf="showPinModal">
			<div class="modal pin-modal">
				<div class="modal-header">
					<h3>
						<!--<span class="material-icons">{{ isLocked ? 'lock' : 'lock_open' }}</span>-->
						{{ isLocked ? 'Desbloquear' : 'Bloquear' }} Gramola
					</h3>
					
				</div>
				<div class="modal-body pin-modal-body">
					<p class="pin-instruction">
						{{ isLocked ? 'Introduce el PIN para desbloquear' : 'Introduce un PIN de 4 d√≠gitos' }}
					</p>
					<input 
						type="password" 
						[(ngModel)]="pinInput"
						(input)="onPinInput($event)"
						placeholder="****"
						class="pin-input"
						maxlength="4"
						autofocus />
					<p class="pin-error" *ngIf="pinError">{{ pinError }}</p>
					<button 
						class="btn btn-primary"
						(click)="confirmPin()"
						[disabled]="pinInput.length !== 4">
						{{ isLocked ? 'Desbloquear' : 'Bloquear' }}
					</button>
				</div>
			</div>
		</div>

		<!-- Modal de Pago por Canci√≥n -->
		<div class="modal-overlay" *ngIf="showPaymentModal">
			<div class="modal pin-modal">
				<div class="modal-header">
					<h3>üí≥ Pagar Canci√≥n</h3>
					<button class="close-button" (click)="closePaymentModal()">‚úñ</button>
				</div>
				<div class="modal-body pin-modal-body">
					<div class="payment-track-info" *ngIf="selectedTrackToPay">
						<img [src]="selectedTrackToPay.album.images[2]?.url || selectedTrackToPay.album.images[0]?.url" 
							 [alt]="selectedTrackToPay.name"
							 class="payment-track-image">
						<h4>{{ selectedTrackToPay.name }}</h4>
						<p>{{ selectedTrackToPay.artists[0].name }}</p>
					</div>
					<div class="payment-amount">
						<h2>{{ costeCancion.toFixed(2) }}‚Ç¨</h2>
					</div>
					<p class="payment-instruction">
						Ingresa los datos de tu tarjeta para completar el pago
					</p>
					
					<!-- Stripe Card Element -->
					<div class="card-element-container">
						<div id="song-card-element"></div>
						<p class="pin-error" *ngIf="cardErrors">{{ cardErrors }}</p>
					</div>
					
					<p class="pin-error" *ngIf="paymentError">{{ paymentError }}</p>
					<div class="payment-buttons">
						<button 
							class="btn btn-primary"
							(click)="confirmPayment()"
							[disabled]="paymentProcessing">
							{{ paymentProcessing ? 'Procesando...' : 'Confirmar Pago' }}
						</button>
						<button 
							class="btn btn-secondary"
							(click)="closePaymentModal()"
							[disabled]="paymentProcessing">
							Cancelar
						</button>
					</div>
				</div>
			</div>
		</div>
	</div>
</div>